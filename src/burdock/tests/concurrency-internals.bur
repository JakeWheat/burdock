
#|

tests for the internals of the concurrency implementation, things that
users won't usually use directly

|#

include concurrency-internals

#|

an inbox is an stm tqueue - you can write to it from any thread, but
you should only read from it from a single thread. it supports a close
state, which is useful for troubleshooting - it means users get better
error messages when they misuse the concurrency system

These aren't really intended to be used directly by users, only via
the implicit self inbox that gets created when you spawn a thread,
and one is implicitly created for api calls to use as their self.

|#

check "inboxes basics":

# create inbox, send and receive
  block:
    ib = make-inbox()
    send-inbox(ib, "test message")
    receive-inbox(ib) is "test message"
  end

  # try to send on closed inbox

  block:
    ib = make-inbox()
    close-inbox(ib)
    send-inbox(ib, "test message") raises "tried to use closed inbox"
  end

  # try to receive on closed inbox

  block:
    ib = make-inbox()
    close-inbox(ib)
    receive-inbox(ib) raises "tried to use closed inbox"
  end


end
